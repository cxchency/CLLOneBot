# 密码输入功能说明

## 功能概述

当 API 返回 401 状态码时，会自动弹出密码输入对话框，要求用户输入 WebUI 密码。

## 功能特点

### 1. 强制输入
- ❌ 不能通过 ESC 键关闭
- ❌ 不能通过点击背景关闭
- ❌ 没有"取消"按钮
- ✅ 必须输入正确密码才能继续

### 2. 密码重试
- 如果密码错误，会显示错误提示："密码错误，请重新输入"
- 最多重试 5 次
- 每次输入错误后会重新发起 API 请求验证

### 3. 用户体验
- 对话框打开时自动聚焦输入框
- 支持按 Enter 键提交密码
- 支持显示/隐藏密码（眼睛图标）
- 实时错误提示显示在输入框下方
- 美观的现代化设计

### 4. 存储机制
- 密码验证成功后自动存储到 localStorage
- Key: `webui_token`
- 下次访问时自动使用存储的 token

## 工作流程

```
1. 用户访问页面
   ↓
2. 加载配置 (调用 /api/config)
   ↓
3. 如果返回 401
   ↓
4. 弹出密码输入对话框
   ↓
5. 用户输入密码并点击"确定"
   ↓
6. 使用新密码重新请求 API
   ↓
7a. 成功 (200) → 关闭对话框，显示配置
   ↓
7b. 失败 (401) → 显示错误，要求重新输入
   ↓
8. 重复 5-7，最多 5 次
```

## 代码结构

### 1. TokenDialog 组件
- 位置: `src/components/TokenDialog.tsx`
- 功能: 密码输入对话框 UI
- Props:
  - `visible`: 是否显示
  - `onConfirm`: 确认回调
  - `onClose?`: 关闭回调（可选，当前未使用）
  - `error?`: 错误信息

### 2. API 工具函数
- 位置: `src/utils/api.ts`
- 关键函数:
  - `setPasswordPromptHandler()`: 设置密码提示处理器
  - `apiFetch()`: 封装的 fetch，自动处理 401
  - `getToken()`: 获取存储的 token
  - `setTokenStorage()`: 存储 token

### 3. App 组件
- 位置: `src/App.tsx`
- 功能:
  - 初始化密码提示处理器
  - 管理对话框显示状态
  - 处理密码确认逻辑

## 测试场景

### 场景 1: 首次访问（无 token）
1. 清空 localStorage: `localStorage.clear()`
2. 刷新页面
3. 应该弹出密码输入对话框
4. 输入正确密码
5. 对话框关闭，显示配置页面

### 场景 2: token 过期
1. localStorage 中有旧的 token
2. 服务器返回 401
3. 弹出密码输入对话框
4. 输入正确密码
5. 更新 localStorage，显示配置页面

### 场景 3: 密码错误
1. 弹出密码输入对话框
2. 输入错误密码
3. 显示错误提示："密码错误，请重新输入"
4. 对话框不关闭，继续等待输入

### 场景 4: 空密码
1. 弹出密码输入对话框
2. 不输入任何内容，点击"确定"
3. "确定"按钮应该是禁用状态（灰色）
4. 无法提交

## 与原 Vue 版本的对比

| 功能 | Vue 版本 | React 版本 |
|------|---------|-----------|
| 401 自动弹窗 | ✅ | ✅ |
| 密码重试 | ✅ | ✅ (优化) |
| 防止关闭 | ✅ | ✅ |
| 错误提示 | ✅ | ✅ |
| 自动聚焦 | ✅ | ✅ |
| Enter 提交 | ✅ | ✅ |
| 显示/隐藏密码 | ✅ | ✅ (新增眼睛图标) |
| 美观设计 | Element Plus | ✅ Tailwind (更现代) |

## 注意事项

1. **密码存储**: 密码以明文形式存储在 localStorage 中，请确保用户了解这一点
2. **重试次数**: 当前限制为 5 次，可在 `api.ts` 中的 `maxRetries` 变量修改
3. **错误提示**: 错误信息通过 `passwordError` 状态传递
4. **关闭对话框**: 当前不允许关闭，必须输入正确密码
